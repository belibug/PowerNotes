name: Publish Module

on:
  push:
    tags:
      - "*"

  workflow_dispatch:

defaults:
  run:
    shell: pwsh

jobs:
  Publish:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install ModuleTools module form PSGallery
        run: Install-PSResource -Repository PSGallery -Name ModuleTools -TrustRepository

      - name: ğŸ—ï¸ Build Module
        run: Invoke-MTBuild -Verbose

      - name: ğŸ§ª Run Pester Tests
        run: Invoke-MTTest

      - name: ğŸš€ Publish Package to PSGallery
        run: |
          try {
            $ProjectInfo = Get-MTProjectInfo
            Publish-PSResource -Path  $ProjectInfo.OutputModuleDir -Repository PSGallery -ApiKey $Env:ApiKey -Verbose
          } catch {
            Write-Error "Publishing to PSGallery failed: $($_.Exception.Message)"
            exit 1 # Fail the workflow on error
          }
        env:
          ApiKey: ${{ secrets.PSGALLERY_API }}
